move message processor into client